{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/lirongjie/mywork/AI_Creation_Hub/ai-creation-hub/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,sMAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 59, "column": 0}, "map": {"version":3,"sources":["file:///Users/lirongjie/mywork/AI_Creation_Hub/ai-creation-hub/src/app/api/contents/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { ContentType, ContentStatus } from '@prisma/client'\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-at-least-32-characters-long-for-security'\n\n// 验证JWT token\nfunction verifyToken(token: string): { userId: string; username: string; role: string } | null {\n  try {\n    const parts = token.split('.')\n    if (parts.length !== 3) return null\n    \n    const body = JSON.parse(atob(parts[1]))\n    \n    // 检查是否过期\n    if (body.exp && body.exp < Math.floor(Date.now() / 1000)) {\n      return null\n    }\n    \n    // 验证签名\n    const expectedSignature = btoa(parts[0] + '.' + parts[1] + '.' + JWT_SECRET)\n    if (parts[2] !== expectedSignature) {\n      return null\n    }\n    \n    return {\n      userId: body.userId,\n      username: body.username,\n      role: body.role,\n    }\n  } catch {\n    return null\n  }\n}\n\n// 验证用户\nasync function validateUser(request: NextRequest) {\n  const authHeader = request.headers.get('Authorization')\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return { valid: false, error: '请先登录', status: 401 }\n  }\n  \n  const token = authHeader.substring(7)\n  const decoded = verifyToken(token)\n  \n  if (!decoded) {\n    return { valid: false, error: '登录已过期，请重新登录', status: 401 }\n  }\n  \n  // 验证用户是否存在\n  const user = await prisma.user.findUnique({\n    where: { id: decoded.userId },\n  })\n  \n  if (!user) {\n    return { valid: false, error: '用户不存在', status: 401 }\n  }\n  \n  return { valid: true, userId: user.id }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    // 验证用户登录\n    const validation = await validateUser(request)\n    if (!validation.valid) {\n      return NextResponse.json(\n        { success: false, error: validation.error },\n        { status: validation.status }\n      )\n    }\n    \n    const userId = validation.userId!\n    const { searchParams } = new URL(request.url)\n    const contentId = searchParams.get('id')\n    const category = searchParams.get('category')\n    const type = searchParams.get('type') as ContentType | null\n    const search = searchParams.get('search')\n    \n    if (contentId) {\n      const content = await prisma.content.findFirst({\n        where: {\n          id: contentId,\n          status: ContentStatus.APPROVED,\n        },\n        include: {\n          author: {\n            select: { id: true, name: true, role: true, avatar: true },\n          },\n          comments: {\n            where: { status: ContentStatus.APPROVED },\n            include: {\n              author: {\n                select: { id: true, name: true, role: true, avatar: true },\n              },\n            },\n            orderBy: { createdAt: 'desc' },\n          },\n          likes: {\n            where: { userId },\n            select: { id: true },\n          },\n          _count: {\n            select: { likes: true },\n          },\n        },\n      })\n      \n      if (!content) {\n        return NextResponse.json(\n          { success: false, error: 'Content not found' },\n          { status: 404 }\n        )\n      }\n      \n      // 添加是否已点赞标记\n      const result = {\n        ...content,\n        isLiked: content.likes.length > 0,\n        likes: undefined, // 移除likes数组\n      }\n      \n      return NextResponse.json({ success: true, data: result })\n    }\n    \n    const where: {\n      status: ContentStatus\n      category?: string\n      type?: ContentType\n      OR?: Array<{ title: { contains: string } } | { body: { contains: string } }>\n    } = {\n      status: ContentStatus.APPROVED,\n    }\n    \n    if (category) where.category = category\n    if (type && Object.values(ContentType).includes(type)) where.type = type\n    if (search) {\n      where.OR = [\n        { title: { contains: search } },\n        { body: { contains: search } },\n      ]\n    }\n    \n    const contents = await prisma.content.findMany({\n      where,\n      include: {\n        author: {\n          select: { id: true, name: true, role: true, avatar: true },\n        },\n        likes: {\n          where: { userId },\n          select: { id: true },\n        },\n        _count: {\n          select: { likes: true, comments: true },\n        },\n      },\n      orderBy: {\n        publishedAt: 'desc',\n      },\n    })\n    \n    // 添加是否已点赞标记\n    const contentsWithLikeStatus = contents.map(content => ({\n      ...content,\n      isLiked: content.likes.length > 0,\n      likes: undefined,\n    }))\n    \n    const categories = await prisma.content.findMany({\n      where: { status: ContentStatus.APPROVED },\n      select: { category: true },\n      distinct: ['category'],\n    })\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        contents: contentsWithLikeStatus,\n        categories: categories.map(c => c.category).filter(Boolean),\n      },\n    })\n  } catch (error) {\n    console.error('Error fetching contents:', error)\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}"],"names":[],"mappings":"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"}}]
}