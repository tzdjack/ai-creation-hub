{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/lirongjie/mywork/AI_Creation_Hub/ai-creation-hub/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,sMAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 59, "column": 0}, "map": {"version":3,"sources":["file:///Users/lirongjie/mywork/AI_Creation_Hub/ai-creation-hub/src/app/api/admin/audit/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { ContentStatus } from '@prisma/client'\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-at-least-32-characters-long-for-security'\n\n// 验证JWT token\nfunction verifyToken(token: string): { userId: string; username: string; role: string } | null {\n  try {\n    const parts = token.split('.')\n    if (parts.length !== 3) return null\n    \n    const body = JSON.parse(atob(parts[1]))\n    \n    // 检查是否过期\n    if (body.exp && body.exp < Math.floor(Date.now() / 1000)) {\n      return null\n    }\n    \n    // 验证签名（简化版）\n    const expectedSignature = btoa(parts[0] + '.' + parts[1] + '.' + JWT_SECRET)\n    if (parts[2] !== expectedSignature) {\n      return null\n    }\n    \n    return {\n      userId: body.userId,\n      username: body.username,\n      role: body.role,\n    }\n  } catch {\n    return null\n  }\n}\n\n// 验证管理员身份\nasync function validateAdmin(request: NextRequest) {\n  const authHeader = request.headers.get('Authorization')\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return { valid: false, error: '未登录', status: 401 }\n  }\n  \n  const token = authHeader.substring(7)\n  const decoded = verifyToken(token)\n  \n  if (!decoded) {\n    return { valid: false, error: '登录已过期，请重新登录', status: 401 }\n  }\n  \n  // 验证用户是否仍然存在且是管理员\n  const user = await prisma.user.findFirst({\n    where: {\n      id: decoded.userId,\n      role: 'HUMAN',\n    },\n  })\n  \n  if (!user) {\n    return { valid: false, error: '用户不存在或权限已变更', status: 401 }\n  }\n  \n  return { valid: true, userId: user.id, username: user.name }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const validation = await validateAdmin(request)\n    \n    if (!validation.valid) {\n      return NextResponse.json(\n        { success: false, error: validation.error },\n        { status: validation.status }\n      )\n    }\n    \n    const { searchParams } = new URL(request.url)\n    const type = searchParams.get('type') || 'content'\n    const status = searchParams.get('status') as ContentStatus | null\n    \n    if (type === 'content') {\n      const where: { status?: ContentStatus } = {}\n      if (status && Object.values(ContentStatus).includes(status)) {\n        where.status = status\n      }\n      \n      const contents = await prisma.content.findMany({\n        where,\n        include: {\n          author: {\n            select: { id: true, name: true, role: true },\n          },\n        },\n        orderBy: {\n          createdAt: 'desc',\n        },\n      })\n      \n      return NextResponse.json({ success: true, data: contents })\n    } else if (type === 'comment') {\n      const where: { status?: ContentStatus } = {}\n      if (status && Object.values(ContentStatus).includes(status)) {\n        where.status = status\n      }\n      \n      const comments = await prisma.comment.findMany({\n        where,\n        include: {\n          author: {\n            select: { id: true, name: true, role: true },\n          },\n          parent: {\n            select: { id: true, title: true },\n          },\n        },\n        orderBy: {\n          createdAt: 'desc',\n        },\n      })\n      \n      return NextResponse.json({ success: true, data: comments })\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Invalid type. Use \"content\" or \"comment\"' },\n      { status: 400 }\n    )\n  } catch (error) {\n    console.error('Error fetching audit queue:', error)\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const validation = await validateAdmin(request)\n    \n    if (!validation.valid) {\n      return NextResponse.json(\n        { success: false, error: validation.error },\n        { status: validation.status }\n      )\n    }\n    \n    const body = await request.json()\n    const { type, id, action, reason } = body\n    \n    if (!type || !id || !action) {\n      return NextResponse.json(\n        { success: false, error: 'Missing required fields: type, id, action' },\n        { status: 400 }\n      )\n    }\n    \n    if (!['content', 'comment'].includes(type)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid type. Use \"content\" or \"comment\"' },\n        { status: 400 }\n      )\n    }\n    \n    if (!['approve', 'reject'].includes(action)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid action. Use \"approve\" or \"reject\"' },\n        { status: 400 }\n      )\n    }\n    \n    const newStatus = action === 'approve' ? ContentStatus.APPROVED : ContentStatus.REJECTED\n    \n    if (type === 'content') {\n      const content = await prisma.content.findUnique({\n        where: { id },\n      })\n      \n      if (!content) {\n        return NextResponse.json(\n          { success: false, error: 'Content not found' },\n          { status: 404 }\n        )\n      }\n      \n      const updateData: {\n        status: ContentStatus\n        rejectReason?: string | null\n        publishedAt?: Date | null\n      } = { status: newStatus }\n      \n      if (action === 'reject') {\n        updateData.rejectReason = reason || 'Not specified'\n        updateData.publishedAt = null\n      } else {\n        updateData.rejectReason = null\n        updateData.publishedAt = new Date()\n      }\n      \n      await prisma.content.update({\n        where: { id },\n        data: updateData,\n      })\n      \n      await prisma.auditLog.create({\n        data: {\n          action: action.toUpperCase() + '_CONTENT',\n          targetType: 'CONTENT',\n          targetId: id,\n          reviewerId: validation.userId!,\n          details: action === 'reject' \n            ? `Rejected: ${reason || 'Not specified'}` \n            : 'Approved',\n        },\n      })\n    } else {\n      const comment = await prisma.comment.findUnique({\n        where: { id },\n      })\n      \n      if (!comment) {\n        return NextResponse.json(\n          { success: false, error: 'Comment not found' },\n          { status: 404 }\n        )\n      }\n      \n      const updateData: {\n        status: ContentStatus\n        rejectReason?: string | null\n      } = { status: newStatus }\n      \n      if (action === 'reject') {\n        updateData.rejectReason = reason || 'Not specified'\n      } else {\n        updateData.rejectReason = null\n      }\n      \n      await prisma.comment.update({\n        where: { id },\n        data: updateData,\n      })\n      \n      await prisma.auditLog.create({\n        data: {\n          action: action.toUpperCase() + '_COMMENT',\n          targetType: 'COMMENT',\n          targetId: id,\n          reviewerId: validation.userId!,\n          details: action === 'reject' \n            ? `Rejected: ${reason || 'Not specified'}` \n            : 'Approved',\n        },\n      })\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        id,\n        type,\n        action,\n        newStatus,\n      },\n    })\n  } catch (error) {\n    console.error('Error processing audit action:', error)\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}"],"names":[],"mappings":"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"}}]
}